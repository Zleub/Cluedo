<html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"> <style>
	.KEYW {color: #933;}
	.COMM {color: #bbb; font-style: italic;}
	.NUMB {color: #393;}
	.STRN {color: #393;}
	.REGX {color: #339;}
	.line {border-right: 1px dotted #666; color: #666; font-style: normal;}
	</style></head><body><pre><span class='line'>  1</span> <span class="COMM">//           `--::-.`</span><span class="WHIT">
<span class='line'>  2</span> </span><span class="COMM">//       ./shddddddddhs+.</span><span class="WHIT">
<span class='line'>  3</span> </span><span class="COMM">//     :yddddddddddddddddy:</span><span class="WHIT">
<span class='line'>  4</span> </span><span class="COMM">//   `sdddddddddddddddddddds`</span><span class="WHIT">
<span class='line'>  5</span> </span><span class="COMM">//  /ddddy:oddddddddds:sddddd/   @By: Debray Arnaud &lt;adebray> - adebray@student.42.fr</span><span class="WHIT">
<span class='line'>  6</span> </span><span class="COMM">//  sdddddddddddddddddddddddds   @Last modified by: adebray</span><span class="WHIT">
<span class='line'>  7</span> </span><span class="COMM">//  sdddddddddddddddddddddddds</span><span class="WHIT">
<span class='line'>  8</span> </span><span class="COMM">//  :ddddddddddhyyddddddddddd:   @Created: 2017-08-06T02:51:52+02:00</span><span class="WHIT">
<span class='line'>  9</span> </span><span class="COMM">//   odddddddd/`:-`sdddddddds    @Modified: 2017-09-15T11:53:57+02:00</span><span class="WHIT">
<span class='line'> 10</span> </span><span class="COMM">//    +ddddddh`+dh +dddddddo</span><span class="WHIT">
<span class='line'> 11</span> </span><span class="COMM">//     -sdddddh///sdddddds-</span><span class="WHIT">
<span class='line'> 12</span> </span><span class="COMM">//       .+ydddddddddhs/.</span><span class="WHIT">
<span class='line'> 13</span> </span><span class="COMM">//           .-::::-`</span><span class="WHIT">
<span class='line'> 14</span> 
<span class='line'> 15</span> </span><span class="KEYW">const</span><span class="WHIT"> </span><span class="NAME">fs</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">require</span><span class="PUNC">(</span><span class="STRN">'fs'</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'> 16</span> </span><span class="KEYW">const</span><span class="WHIT"> </span><span class="NAME">util</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">require</span><span class="PUNC">(</span><span class="STRN">'util'</span><span class="PUNC">)</span><span class="PUNC">;</span><span class="WHIT">
<span class='line'> 17</span> 
<span class='line'> 18</span> </span><span class="NAME">exports.getopt</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">options</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="PUNC">></span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'> 19</span> </span><span class="WHIT">	</span><span class="NAME">let</span><span class="WHIT"> </span><span class="NAME">opts</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'> 20</span> </span><span class="WHIT">	</span><span class="NAME">process.argv.forEach</span><span class="PUNC">(</span><span class="PUNC">(</span><span class="NAME">arg</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="PUNC">></span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'> 21</span> </span><span class="WHIT">		</span><span class="NAME">options.forEach</span><span class="PUNC">(</span><span class="NAME">t</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="PUNC">></span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'> 22</span> </span><span class="WHIT">			</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">t</span><span class="PUNC">[</span><span class="NUMB">0</span><span class="PUNC">]</span><span class="PUNC">.</span><span class="NAME">some</span><span class="PUNC">(</span><span class="NAME">e</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="PUNC">></span><span class="WHIT"> </span><span class="NAME">e</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">arg</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'> 23</span> </span><span class="WHIT">				</span><span class="NAME">t</span><span class="PUNC">[</span><span class="NUMB">2</span><span class="PUNC">]</span><span class="PUNC">(</span><span class="NAME">opts</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">process.argv</span><span class="PUNC">[</span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">+</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">]</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'> 24</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'> 25</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'> 26</span> </span><span class="WHIT">	</span><span class="KEYW">return</span><span class="WHIT"> </span><span class="NAME">opts</span><span class="WHIT">
<span class='line'> 27</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'> 28</span> 
<span class='line'> 29</span> </span><span class="KEYW">const</span><span class="WHIT"> </span><span class="NAME">verbose</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">.</span><span class="PUNC">.</span><span class="PUNC">.</span><span class="NAME">s</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="PUNC">></span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'> 30</span> </span><span class="WHIT">	</span><span class="NAME">let</span><span class="WHIT"> </span><span class="NAME">_verbose</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">e</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="NAME">i</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="PUNC">></span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'> 31</span> </span><span class="WHIT">		</span><span class="NAME">process.stdout.write</span><span class="PUNC">(</span><span class="NAME">util.inspect</span><span class="PUNC">(</span><span class="NAME">e</span><span class="PUNC">,</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'> 32</span> </span><span class="WHIT">			</span><span class="NAME">depth</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">null</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'> 33</span> </span><span class="WHIT">			</span><span class="NAME">colors</span><span class="PUNC">:</span><span class="WHIT"> </span><span class="KEYW">true</span><span class="PUNC">,</span><span class="WHIT">
<span class='line'> 34</span> </span><span class="WHIT">			</span><span class="COMM">// showHidden: true</span><span class="WHIT">
<span class='line'> 35</span> </span><span class="WHIT">		</span><span class="PUNC">}</span><span class="PUNC">)</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'> 36</span> </span><span class="WHIT">		</span><span class="KEYW">if</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="NAME">i</span><span class="WHIT"> </span><span class="PUNC">==</span><span class="WHIT"> </span><span class="NAME">s.length</span><span class="WHIT"> </span><span class="PUNC">-</span><span class="WHIT"> </span><span class="NUMB">1</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'> 37</span> </span><span class="WHIT">			</span><span class="NAME">process.stdout.write</span><span class="PUNC">(</span><span class="STRN">"\n"</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'> 38</span> </span><span class="WHIT">		</span><span class="KEYW">else</span><span class="WHIT">
<span class='line'> 39</span> </span><span class="WHIT">			</span><span class="NAME">process.stdout.write</span><span class="PUNC">(</span><span class="STRN">"  "</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'> 40</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT">
<span class='line'> 41</span> </span><span class="WHIT">	</span><span class="NAME">s.forEach</span><span class="PUNC">(</span><span class="NAME">_verbose</span><span class="PUNC">)</span><span class="WHIT">
<span class='line'> 42</span> </span><span class="PUNC">}</span><span class="WHIT">
<span class='line'> 43</span> </span><span class="NAME">exports.verbose</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">verbose</span><span class="WHIT">
<span class='line'> 44</span> 
<span class='line'> 45</span> </span><span class="NAME">exports.load</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="PUNC">(</span><span class="PUNC">)</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="PUNC">></span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'> 46</span> </span><span class="WHIT">	</span><span class="NAME">let</span><span class="WHIT"> </span><span class="PUNC">{</span><span class="WHIT">
<span class='line'> 47</span> </span><span class="WHIT">		</span><span class="NAME">talesFactory</span><span class="WHIT">
<span class='line'> 48</span> </span><span class="WHIT">	</span><span class="PUNC">}</span><span class="WHIT"> </span><span class="PUNC">=</span><span class="WHIT"> </span><span class="NAME">require</span><span class="PUNC">(</span><span class="TOKN">`</span><span class="PUNC">.</span><span class="REGX">/micro-talespin.js`)
<span class='line'> 49</span> 	let files = fs.readdirSync('./</span><span class="NAME">server</span><span class="PUNC">/</span><span class="NAME">micro</span><span class="PUNC">-</span><span class="NAME">talespin</span><span class="PUNC">/</span><span class="STRN">')
<span class='line'> 50</span> 	let data = files.reduce((p, e) => {
<span class='line'> 51</span> 		if (e != '</span><span class="NAME">index.js</span><span class="STRN">' && e != '</span><span class="NAME">micro</span><span class="PUNC">-</span><span class="NAME">talespin.js</span><span class="STRN">' && e.match(/.*\.js$/)) {
<span class='line'> 52</span> 			delete require.cache[`./${e}`]
<span class='line'> 53</span> 			let _ = require(`./${e}`)
<span class='line'> 54</span> 
<span class='line'> 55</span> 			if (_.talesFactory)
<span class='line'> 56</span> 				talesFactory = _.talesFactory
<span class='line'> 57</span> 			Object.keys(_).forEach(k => {
<span class='line'> 58</span> 				if (p[k])
<span class='line'> 59</span> 					console.warn(`warning, erasing ${k}`)
<span class='line'> 60</span> 				p[k] = _[k]
<span class='line'> 61</span> 			})
<span class='line'> 62</span> 		}
<span class='line'> 63</span> 		return p
<span class='line'> 64</span> 	}, {})
<span class='line'> 65</span> 
<span class='line'> 66</span> 	return new talesFactory(data)
<span class='line'> 67</span> }
<span class='line'> 68</span> 
<span class='line'> 69</span> let Dictionary = class extends Object {
<span class='line'> 70</span> 	static isDictionary(e) {
<span class='line'> 71</span> 		return e instanceof Dictionary
<span class='line'> 72</span> 	}
<span class='line'> 73</span> }
<span class='line'> 74</span> 
<span class='line'> 75</span> exports.DictionaryFunctor = (type) => {
<span class='line'> 76</span> 	let _class = class extends Dictionary {
<span class='line'> 77</span> 		static get name() {
<span class='line'> 78</span> 			return type.name + "Dictionary"
<span class='line'> 79</span> 		}
<span class='line'> 80</span> 
<span class='line'> 81</span> 		static get type() {
<span class='line'> 82</span> 			return type
<span class='line'> 83</span> 		}
<span class='line'> 84</span> 
<span class='line'> 85</span> 		insert(k, v) {
<span class='line'> 86</span> 			if (v.constructor.name != type.name)
<span class='line'> 87</span> 				throw `No such type ${v.constructor.name} in ${this.name}`
<span class='line'> 88</span> 			else
<span class='line'> 89</span> 				this[k] = v
<span class='line'> 90</span> 		}
<span class='line'> 91</span> 	}
<span class='line'> 92</span> 	return _class
<span class='line'> 93</span> }
<span class='line'> 94</span> 
<span class='line'> 95</span> exports.ArrayFunctor = (type) => {
<span class='line'> 96</span> 	let _class = class extends Array {
<span class='line'> 97</span> 		static get type() {
<span class='line'> 98</span> 			return type
<span class='line'> 99</span> 		}
<span class='line'>100</span> 
<span class='line'>101</span> 		static get name() {
<span class='line'>102</span> 			return type.name + "Array"
<span class='line'>103</span> 		}
<span class='line'>104</span> 
<span class='line'>105</span> 		push(v) {
<span class='line'>106</span> 			if (v.constructor.name != type.name)
<span class='line'>107</span> 				throw `No such type ${v.constructor.name} in ${this.name}`
<span class='line'>108</span> 			else
<span class='line'>109</span> 				Array.prototype.push.call(this, v)
<span class='line'>110</span> 		}
<span class='line'>111</span> 	}
<span class='line'>112</span> 	return _class
<span class='line'>113</span> }
<span class='line'>114</span> 
<span class='line'>115</span> const JStoQraphQL = (object) => {
<span class='line'>116</span> 	let type = typeof(object)
<span class='line'>117</span> 	if (type == "number")
<span class='line'>118</span> 		return "Int".green
<span class='line'>119</span> 	else if (type == "string")
<span class='line'>120</span> 		return "String".green
<span class='line'>121</span> 	else if (type == "object" && object) {
<span class='line'>122</span> 		return object.constructor.name
<span class='line'>123</span> 	}
<span class='line'>124</span> 	// else if (type == "function")
<span class='line'>125</span> 	// 	return "Function"
<span class='line'>126</span> }
<span class='line'>127</span> 
<span class='line'>128</span> const toGraphQLString = (that, types) => (p, k) => {
<span class='line'>129</span> 	let t = JStoQraphQL(that[k])
<span class='line'>130</span> 	if (!t)
<span class='line'>131</span> 		return p
<span class='line'>132</span> 
<span class='line'>133</span> 	if (t == '</span><span class="NAME">Int</span><span class="STRN">' || t == '</span><span class="NAME">String</span><span class="STRN">')
<span class='line'>134</span> 		return p + "    " + k + ": " + t + "\n"
<span class='line'>135</span> 	if (t == "Function")
<span class='line'>136</span> 		return p + "    " + k + "(" + " ??? " + "): " + t.red + "\n"
<span class='line'>137</span> 	else if (that[k] instanceof Array && that[k].constructor.type) {
<span class='line'>138</span> 		types.push(that[k])
<span class='line'>139</span> 		return p + "    " + k + ": [" + that[k].constructor.type.name + "]!\n"
<span class='line'>140</span> 	} else if (that[k] instanceof Object) {
<span class='line'>141</span> 		// if (Dictionary.isDictionary(that[k])) {
<span class='line'>142</span> 		// 	if (that[k][ Object.keys(that[k])[0] ] instanceof Object)
<span class='line'>143</span> 		// 		types.push(that[k][ Object.keys(that[k])[0] ])
<span class='line'>144</span> 		// 	return p + "    " + k + "(item: String): " + `${that[k].constructor.type.name}!\n`
<span class='line'>145</span> 		// }
<span class='line'>146</span> 		// if (that[k][0]) {
<span class='line'>147</span> 		that[k].constructor = {}
<span class='line'>148</span> 		that[k].constructor.name = k
<span class='line'>149</span> 		types.push(that[k])
<span class='line'>150</span> 		// return p + "    " + k + "(key: Int): [" + t + "]!\n"
<span class='line'>151</span> 		return p + "    " + k + "(key: String): " + JStoQraphQL(that[k]) + "\n"
<span class='line'>152</span> 
<span class='line'>153</span> 	} else
<span class='line'>154</span> 		return p + "    " + k + ": " + t + "\n"
<span class='line'>155</span> }
<span class='line'>156</span> 
<span class='line'>157</span> // const introspect = function (schema) {
<span class='line'>158</span> // 	if (schema) {
<span class='line'>159</span> // 		if (schema.match(`type ${this.constructor.name} {`))
<span class='line'>160</span> // 			return schema
<span class='line'>161</span> // 		schema += `type ${this.constructor.name} {\n`
<span class='line'>162</span> // 	}
<span class='line'>163</span> // 	else
<span class='line'>164</span> // 		schema = `type ${this.constructor.name} {\n`
<span class='line'>165</span> //
<span class='line'>166</span> // 	let childs = []
<span class='line'>167</span> // 	let keys = []
<span class='line'>168</span> // 	let e = this
<span class='line'>169</span> // 	do {
<span class='line'>170</span> // 		keys = keys.concat(Object.getOwnPropertyNames(e)).filter(function(item, pos, self) {
<span class='line'>171</span> // 			return self.indexOf(item) == pos;
<span class='line'>172</span> // 		})
<span class='line'>173</span> // 		e = e.__proto__
<span class='line'>174</span> // 	} while (e != null)
<span class='line'>175</span> // 	// let keys = Object.keys(this).concat( Object.keys(Object.getPrototypeOf(this)) )
<span class='line'>176</span> //
<span class='line'>177</span> // 	schema += keys.reduce( toGraphQLString(this, childs), "")
<span class='line'>178</span> // 	schema += "}\n"
<span class='line'>179</span> //
<span class='line'>180</span> // 	childs.forEach( e => schema = introspect.call(e, schema) )
<span class='line'>181</span> // 	return schema
<span class='line'>182</span> // }
<span class='line'>183</span> 
<span class='line'>184</span> class Schema extends Array {
<span class='line'>185</span> 	inspect() {
<span class='line'>186</span> 		process.stdout.write(JSON.stringify(this, null, "  ") + "\n")
<span class='line'>187</span> 		let childs_type = []
<span class='line'>188</span> 		let childs = this.reduce((p, e) => {
<span class='line'>189</span> 			if (e[1] instanceof Schema) {
<span class='line'>190</span> 				if (e[1][0][1] == "Array") {
<span class='line'>191</span> 					return p + '</span><span class="WHIT">  </span><span class="STRN">' + e[0].yellow + ": [" + e[1][1][1] + '</span><span class="PUNC">]</span><span class="TOKN">\</span><span class="NAME">n</span><span class="STRN">'
<span class='line'>192</span> 				} else if (e[1][0][1] == "Object") {
<span class='line'>193</span> 					return p + '</span><span class="WHIT">  </span><span class="STRN">' + e[0].yellow + "(key: String): " + e[1][1][1][0][1] +
<span class='line'>194</span> 						'</span><span class="TOKN">\</span><span class="NAME">n</span><span class="STRN">'
<span class='line'>195</span> 				} else {
<span class='line'>196</span> 					childs_type.push(e[1])
<span class='line'>197</span> 					return p + '</span><span class="WHIT">  </span><span class="STRN">' + e[0].magenta + ": " + e[1][0][1] + "\n"
<span class='line'>198</span> 				}
<span class='line'>199</span> 			} else
<span class='line'>200</span> 				return p + (e == this[0] ? '</span><span class="STRN">' : `  ${e[0]}: ${e[1]}`) + "\n"
<span class='line'>201</span> 		}, "")
<span class='line'>202</span> 		return `type ${this[0][1].cyan} {${childs}}\n` + childs_type.reduce((p, e) => {
<span class='line'>203</span> 			return p + e.inspect()
<span class='line'>204</span> 		}, "")
<span class='line'>205</span> 	}
<span class='line'>206</span> }
<span class='line'>207</span> 
<span class='line'>208</span> const introspect = function(schema) {
<span class='line'>209</span> 	if (!schema) {
<span class='line'>210</span> 		schema = new Schema
<span class='line'>211</span> 		schema.push([, '</span><span class="NAME">Query</span><span class="STRN">'])
<span class='line'>212</span> 	}
<span class='line'>213</span> 
<span class='line'>214</span> 	Object.keys(this).forEach(k => {
<span class='line'>215</span> 		// console.log(k, this[k])
<span class='line'>216</span> 		if (
<span class='line'>217</span> 			typeof this[k] != '</span><span class="NAME">string</span><span class="STRN">' && typeof this[k] != '</span><span class="NAME">number</span><span class="STRN">' &&
<span class='line'>218</span> 			typeof this[k] != '</span><span class="KEYW">function</span><span class="STRN">'
<span class='line'>219</span> 		) {
<span class='line'>220</span> 			let _s = new Schema
<span class='line'>221</span> 			schema.push([k, _s])
<span class='line'>222</span> 			_s.push([k, this[k].constructor.name])
<span class='line'>223</span> 			introspect.call(this[k], _s)
<span class='line'>224</span> 		} else if (typeof this[k] == '</span><span class="NAME">string</span><span class="STRN">' || typeof this[k] == '</span><span class="NAME">number</span><span class="TOKN"></span></pre></body></html>